-- 25/02/2022 15:55 - COMPROVANTE DE ENTREGA - (" LUPEON ")

SET XACT_ABORT ON

BEGIN TRY
    BEGIN TRANSACTION

        ;
        INSERT INTO SIC..LUPEON_OCORRENCIA
          ( LUPEON_ID, OCORRENCIA_ID, OCORRENCIA_NOME, OCORRENCIA_DATA , CdEmpresa, NrSeqControle, VER_ID )
        SELECT
           NFE.ID                             AS LUPEON_ID
          ,999                               AS OCORRENCIA_ID
          ,'COMPROVANTE DE ENTREGA'          AS OCORRENCIA_NOME
          ,CO.OCORRENCIA_DATA                AS OCORRENCIA_DATA
          ,CO.CdEmpresa
          ,CO.NrSeqControle
          ,1
         FROM SIC..LUPEON_NFE NFE

		     JOIN SIC..LUPEON_OCORRENCIA CO ON CO.LUPEON_ID = NFE.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1

-- select ocorrencias = 0001
-- VERIFICAR CF OCORRENCIAS


        WHERE 1=1
    		  AND CO.ID = (SELECT MAX(CO.ID) FROM SIC..LUPEON_OCORRENCIA CO WHERE CO.LUPEON_ID = NFE.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1)
          AND NOT EXISTS ( SELECT 1 FROM SIC..LUPEON_OCORRENCIA CO WHERE CO.LUPEON_ID = NFE.ID AND CO.OCORRENCIA_ID = 999 )          
        ;
        UPDATE NFE 
          SET FASE_ID = 6,
              DT_UPDATE = CURRENT_TIMESTAMP
        FROM  SIC..LUPEON_NFE NFE
        WHERE 1=1
          AND EXISTS ( SELECT 1 FROM SIC..LUPEON_OCORRENCIA CO WHERE CO.LUPEON_ID = NFE.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1 ) 
        ;

    COMMIT TRANSACTION

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION

    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE()
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY()
    DECLARE @ErrorState INT = ERROR_STATE()

    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
END CATCH
;