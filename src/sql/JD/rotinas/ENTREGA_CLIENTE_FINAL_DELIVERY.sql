/*
--GERACAO ENTREGA FINAL
-- NO CLIENTE
*/
INSERT INTO SIC..TABLEJHONDEEREINFO (DATESENDXML,MESSAGETYPE,MESSAGESENDER,MESSAGERECIPIENT,WITSFILENAME,TIMESTAMP,CONTROLNUMBER,INVOICENUMBER,COMMERCIALINVOICENUMBER,CUSTOMER,EVENTTYPE,RAILHEAD,DELIVERYLOC,DEALERDELIVERYDATE,SENDXML)
SELECT 
GETDATE() AS DATESENDXML,
'INVOICE' AS MESSAGETYPE,
'CARRIER_TERM' AS MESSAGESENDER,
'VISIBILITY' AS MESSAGERECIPIENT,
SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),GETDATE(),121),'-',''),':',''),1,8)+SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),DATEADD(second,1,GETDATE()),121),'-',''),':',''),10,6) AS WITSFILENAME,
SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),GETDATE(),121),'-',''),':',''),1,8)+SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),DATEADD(second,1,GETDATE()),121),'-',''),':',''),10,6) AS TIMESTAMP,
(CASE WHEN ISNULL((SELECT MAX(CODEINSERT) FROM SIC..TABLEJHONDEEREINFO),0) = 0 THEN ROW_NUMBER() OVER(ORDER BY GETDATE() ASC) ELSE ISNULL((SELECT MAX(CODEINSERT) FROM SIC..TABLEJHONDEEREINFO),0)+ROW_NUMBER() OVER(ORDER BY GETDATE() ASC) END) AS CONTROLNUMBER,--'' AS CONTROLNUMBER,
NFR.NF AS INVOICENUMBER,
'' AS COMMERCIALINVOICENUMBER,
'JDP' AS CUSTOMER,
'DELIVERY' AS EVENTTYPE,
EMP_ENTREGA.CGC AS RAILHEAD,
CID_DEST.NOME+','+CID_DEST.UF+'-BR' AS DELIVERYLOC,
SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),ENTREGAS.DATABAIXAUSU,121),'-',''),':',''),1,8)+SUBSTRING(REPLACE(REPLACE(CONVERT(varchar(30),ENTREGAS.DATABAIXAUSU,121),'-',''),':',''),10,6) AS DEALERDELIVERYDATE,
'0' AS SENDXML
FROM CARGASSQL..CNH  
LEFT JOIN CARGASSQL..TRB                   ON TRB.EMP_CODIGO_CNH=CNH.EMP_CODIGO AND TRB.CNH_SERIE=CNH.SERIE AND TRB.CNH_CTRC=CNH.CTRC  
LEFT JOIN CARGASSQL..MNF                   ON MNF.EMP_CODIGO=TRB.EMP_CODIGO   AND MNF.CODIGO=TRB.MNF_CODIGO 
LEFT JOIN CARGASSQL..IOP                   ON IOP.EMP_CODIGO = MNF.EMP_CODIGO AND IOP.MNF_CODIGO = MNF.CODIGO 
LEFT JOIN CARGASSQL..OPG                   ON OPG.EMP_CODIGO=IOP.EMP_CODIGO   AND OPG.CODIGO=IOP.OPG_CODIGO   
LEFT JOIN CARGASSQL..CLI REMET             ON REMET.CGCCPF=CNH.CLI_CGCCPF_REMET                               
LEFT JOIN CARGASSQL..CLI DEST              ON DEST.CGCCPF=CNH.CLI_CGCCPF_DEST                                 
LEFT JOIN CARGASSQL..CLI RDS               ON RDS.CGCCPF=CNH.CLI_CGCCPF_RDS                                  
LEFT JOIN CARGASSQL..CLI CNS               ON CNS.CGCCPF=CNH.CLI_CGCCPF_CNS                                   
LEFT JOIN CARGASSQL..CLI EXP               ON EXP.CGCCPF=CNH.CLI_CGCCPF_EXPED                                 
LEFT JOIN CARGASSQL..CLI REC               ON REC.CGCCPF=CNH.CLI_CGCCPF_RECEB                                
LEFT JOIN CARGASSQL..FAT FATURAS           ON FATURAS.CODIGO=CNH.FAT_CODIGO                                   
LEFT JOIN CARGASSQL..CLI CLIPAG            ON CLIPAG.CGCCPF=CNH.CLI_CGCCPF_PAG                                
LEFT JOIN CARGASSQL..CID CIDCOB            ON CIDCOB.CODIGO=CLIPAG.CID_CODIGO                                
LEFT JOIN CARGASSQL..TRE TRE_CNH           ON TRE_CNH.CODIGO=CNH.TRE_CODIGO                                   
LEFT JOIN CARGASSQL..TRE TRE_MNF           ON TRE_MNF.CODIGO=MNF.TRE_CODIGO                                   
LEFT JOIN CARGASSQL..EMP EMP_ORIGEM        ON EMP_ORIGEM.CODIGO=CNH.EMP_CODIGO                                
LEFT JOIN CARGASSQL..IME ENTREGAS          ON ENTREGAS.EMP_CODIGO_CNH=CNH.EMP_CODIGO AND ENTREGAS.CNH_SERIE=CNH.SERIE AND ENTREGAS.CNH_CTRC=CNH.CTRC 
LEFT JOIN CARGASSQL..MEG                   ON MEG.EMP_CODIGO=ENTREGAS.EMP_CODIGO AND MEG.CODIGO=ENTREGAS.MEG_CODIGO                                 
LEFT JOIN CARGASSQL..CID CID_DEST          ON CID_DEST.CODIGO=DEST.CID_CODIGO  
LEFT JOIN CARGASSQL..CID CID_DEST_BASE     ON CID_DEST_BASE.CODIGO=CID_DEST.CID_CODIGO_BASE 
LEFT JOIN CARGASSQL..CID CID_REMET         ON CID_REMET.CODIGO=REMET.CID_CODIGO  
LEFT JOIN CARGASSQL..PFR                   ON PFR.TRE_CODIGO=CNH.TRE_CODIGO AND PFR.SRV_CODIGO=CNH.SRV_CODIGO 
LEFT JOIN CARGASSQL..EMP EMP_ENTREGA       ON EMP_ENTREGA.CODIGO=TRE_CNH.EMP_CODIGO_ENTREGA                   
LEFT JOIN CARGASSQL..VEI VEICNH            ON VEICNH.PLACA=CNH.VEI_PLACA_COL                                  
LEFT JOIN CARGASSQL..SRV                   ON SRV.CODIGO=CNH.SRV_CODIGO                                       
LEFT JOIN CARGASSQL..VEI VEIMNF            ON VEIMNF.PLACA= MNF.VEI_PLACA                                     
LEFT JOIN CARGASSQL..AGR                   ON AGR.CGCCPF = VEIMNF.AGR_CGCCPF                                  
LEFT JOIN CARGASSQL..MOT MOT_MNF           ON MOT_MNF.PRONTUARIO = MNF.MOT_PRONTUARIO                         
LEFT JOIN CARGASSQL..MOT MOT_CNH           ON (MOT_CNH.PRONTUARIO=CNH.MOT_PRONTUARIO)                         
LEFT JOIN CARGASSQL..CTE                   ON CTE.EMP_CODIGO_CNH = CNH.EMP_CODIGO AND CTE.CNH_SERIE = CNH.SERIE AND CTE.CNH_CTRC = CNH.CTRC  
LEFT JOIN CARGASSQL..MNE                   ON MNE.EMP_CODIGO_MNF = MNF.EMP_CODIGO AND MNE.MNF_CODIGO = MNF.CODIGO  
LEFT JOIN CARGASSQL..NFR                   ON NFR.EMP_CODIGO = CNH.EMP_CODIGO AND NFR.CNH_SERIE = CNH.SERIE AND NFR.CNH_CTRC = CNH.CTRC  
LEFT JOIN CARGASSQL..EAT                   ON EAT.EMP_CODIGO_CNH = CNH.EMP_CODIGO AND EAT.CNH_SERIE = CNH.SERIE AND EAT.CNH_CTRC = CNH.CTRC  
LEFT JOIN CARGASSQL..MNF MNF_EAT           ON MNF_EAT.EMP_CODIGO = EAT.EMP_CODIGO_MNF AND MNF_EAT.CODIGO = EAT.MNF_CODIGO  
LEFT JOIN CARGASSQL..TRE TRE_MNF_EAT       ON TRE_MNF_EAT.CODIGO = MNF_EAT.TRE_CODIGO  
LEFT JOIN CARGASSQL..CAE                   ON CAE.EMP_CODIGO_CNH=CNH.EMP_CODIGO AND CAE.CNH_SERIE=CNH.SERIE AND CAE.CNH_CTRC=CNH.CTRC  
LEFT JOIN CARGASSQL..USU					ON CNH.USU_CODIGO = USU.CODIGO  
LEFT JOIN CARGASSQL..IMC					ON CNH.EMP_CODIGO = IMC.EMP_CODIGO_CNH AND CNH.SERIE = IMC.CNH_SERIE AND CNH.CTRC = IMC.CNH_CTRC  
LEFT JOIN CARGASSQL..USU AS USUARIO		ON USUARIO.CODIGO = IMC.USU_CODIGO  
LEFT JOIN CARGASSQL..OCO					ON CNH.OCO_CODIGO = OCO.CODIGO
where  
/*ENTREGAS.DATABAIXAUSU >= GETDATE()-1
AND ENTREGAS.DATABAIXAUSU <= GETDATE()*/
cnh.status='I' 
AND CNH.DATA >= '2020-12-01'
AND ((ENTREGAS.TIPOENTREGA='N') or (ENTREGAS.TIPOENTREGA is null) or  (select count(*) from CARGASSQL..ime  where ime.EMP_CODIGO_CNH=CNH.EMP_CODIGO  AND IME.CNH_SERIE=CNH.SERIE  AND IME.CNH_CTRC=CNH.CTRC)=1 )  
AND (CNH.TIPOCTRC NOT IN (200,201) OR (CNH.TIPOCTRC IS NULL))   
AND ENTREGAS.DATABAIXAUSU IS NOT NULL
AND MNF.PEC_CODIGO IS NOT NULL
AND (SELECT COUNT(INVOICENUMBER) FROM SIC..TABLEJHONDEEREINFO WHERE EVENTTYPE='DELIVERY' AND DELIVERYLOC LIKE '%-BR' AND SENDXML <> 2 AND INVOICENUMBER IN (NFR.NF))=0
--AND ENTREGAS.DATABAIXAUSU >= (CASE WHEN ISNULL((SELECT MAX(DATESENDXML) FROM SIC..TABLEJHONDEEREINFO),0) = 0 THEN GETDATE()-1 ELSE (SELECT MAX(DATESENDXML) FROM SIC..TABLEJHONDEEREINFO WHERE EVENTTYPE='DELIVERY' AND DELIVERYLOC LIKE '%-BR') END)
AND REMET.CGCCPF IN ('89674782001391')
/*AND (REMET.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR DEST.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR RDS.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR CNS.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR EXP.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR REC.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627')
OR CLIPAG.CGCCPF IN ('89674782001200','89674782001634','03982513000133','89674782001391','01329776000112','89674782001049','89674782001553','01329776001356','89674782000158','89674782001472','01329776000627'))*/
/*AND CNH.EMP_CODIGO = 'SPO'
AND CNH.SERIE = 'E'
AND CNH.CTRC = '3165291'*/
--order by CNH.DATA,cnh.emp_codigo,cnh.serie,cnh.ctrc

--SELECT * FROM TABLEJHONDEEREINFO