-- 11/09/2021 10:51 - (999) - COMPROVANTE DE ENTREGA - ITRACK

SET XACT_ABORT ON

BEGIN TRY
    BEGIN TRANSACTION

        ;
        INSERT INTO SIC.dbo.ITRACK_OCORRENCIA
          ( ITRACK_DANFE_ID, OCORRENCIA_ID, OCORRENCIA_NOME, OCORRENCIA_DATA , CdEmpresa, NrSeqControle )
        SELECT
           IT.ID                             AS ITRACK_DANFE_ID
          ,999                               AS OCORRENCIA_ID
          ,'COMPROVANTE DE ENTREGA'          AS OCORRENCIA_NOME
          ,CO.OCORRENCIA_DATA                AS OCORRENCIA_DATA
          ,IT.CdEmpresa
          ,IT.NrSeqControle
         FROM SIC.dbo.ITRACK_DANFE IT
		     JOIN SIC.dbo.ITRACK_OCORRENCIA CO ON CO.ITRACK_DANFE_ID = IT.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1
        WHERE FASE_ID = 5
          AND EXISTS ( SELECT 1 FROM SIC.dbo.ITRACK_OCORRENCIA CO WHERE CO.ITRACK_DANFE_ID = IT.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1 ) 
        -- CASO A (FASE = 5) E  EXISTIR OCORRENCIA = 1 GERADA E ENVIADA, INCLUI OCORRENCIA
        ;
        UPDATE IT 
          SET FASE_ID = 6,
              DT_UPDATE = CURRENT_TIMESTAMP
        FROM  SIC.dbo.ITRACK_DANFE IT
        WHERE FASE_ID = 5
          AND EXISTS ( SELECT 1 FROM SIC.dbo.ITRACK_OCORRENCIA CO WHERE CO.ITRACK_DANFE_ID = IT.ID AND CO.OCORRENCIA_ID = 1 AND CO.FLAG_SEND = 1 ) 
        -- CASO A (FASE = 5) E EXISTIR OCORRENCIA = 1 GERADA E ENVIADA, MUDA PARA FASE = 6
        ;

    COMMIT TRANSACTION

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION

    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE()
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY()
    DECLARE @ErrorState INT = ERROR_STATE()

    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
END CATCH
;