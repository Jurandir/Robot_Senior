DECLARE @CONFIRMAFACILOCORRENCIA_ID as INT
DECLARE @CONFIRMAFACIL_ID           as INT
DECLARE @OCORRENCIA_DATA            as DATETIME
DECLARE @DATAOCO                    as DATETIME
DECLARE @OCORRENCIA_ID              as INT
DECLARE @OCORRENCIA_NOME            as NVARCHAR(60)

DECLARE Ocorrencia_Cursor CURSOR FOR 
SELECT TOP 10
      CO.ID               CONFIRMAFACILOCORRENCIA_ID,
      CF.ID               CONFIRMAFACIL_ID,
	   OUN.DATAOCO         OCORRENCIA_DATA,
	   OUN.OCO_CODIGO      OCORRENCOA_ID,
	   OCO.NOME            OCORRENCIA_NOME,
      OUN.DATAOCO         DATAOCO 
FROM CARGASSQL.dbo.OUN
    JOIN CARGASSQL.dbo.OCO                       ON OCO.CODIGO  = OUN.OCO_CODIGO
    JOIN SIC.dbo.CONFIRMAFACIL CF                ON CF.CTRC     = OUN.CHAVE 
    LEFT JOIN SIC.dbo.CONFIRMAFACILOCORRENCIA CO ON CO.CONFIRMAFACIL_ID = CF.ID AND CO.OCORRENCIA_ID = OUN.OCO_CODIGO AND CO.OCORRENCIA_DATA = OUN.DATAOCO                                          
WHERE 
   OUN.TABELA='CNH' AND
   OUN.OCO_CODIGO NOT IN (000,001,110,128,801) AND  -- ( 098 passou para manual)
   (OCO.NAOENVIAEDI = 0 OR OUN.OCO_CODIGO=219) AND CO.ID IS NULL AND --- 219 = AGUARDANDO AGENDAMENTO/SOLICITADO AGENDA
   CF.FASE_ID < 5
ORDER BY
   OUN.DATA
;	

OPEN Ocorrencia_Cursor;  

FETCH NEXT FROM Ocorrencia_Cursor INTO 
	     @CONFIRMAFACILOCORRENCIA_ID , @CONFIRMAFACIL_ID , @OCORRENCIA_DATA , @OCORRENCIA_ID , @OCORRENCIA_NOME , @DATAOCO ;  

WHILE @@FETCH_STATUS = 0  
BEGIN      
      BEGIN TRANSACTION;

      IF ( @CONFIRMAFACILOCORRENCIA_ID IS NULL )
      BEGIN
         INSERT INTO SIC.dbo.CONFIRMAFACILOCORRENCIA ( CONFIRMAFACIL_ID, OCORRENCIA_ID, OCORRENCIA_NOME, OCORRENCIA_DATA )
         VALUES ( @CONFIRMAFACIL_ID, @OCORRENCIA_ID, @OCORRENCIA_NOME, @DATAOCO )
      END
      ;

      -- Print @@ROWCOUNT
      ; 

      COMMIT TRANSACTION
      ;
      
      -- Print @CONFIRMAFACIL_ID ;
      -- Print @OCORRENCIA_ID ;
      -- Print @OCORRENCIA_DATA ;

      FETCH NEXT FROM Ocorrencia_Cursor INTO 
	     @CONFIRMAFACILOCORRENCIA_ID , @CONFIRMAFACIL_ID , @OCORRENCIA_DATA , @OCORRENCIA_ID , @OCORRENCIA_NOME , @DATAOCO 
      ;  

END
;

CLOSE Ocorrencia_Cursor
;  
DEALLOCATE Ocorrencia_Cursor
;  
