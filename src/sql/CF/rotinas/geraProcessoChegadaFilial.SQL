BEGIN
    UPDATE CF
    SET DT_CHEGADA = CNH.DATACHEGADA
    FROM SIC.dbo.CONFIRMAFACIL CF
    JOIN CARGASSQL.dbo.CNH        ON CNH.EMP_CODIGO = SUBSTRING(CF.CTRC,1,3) AND 
                                     CNH.SERIE      = SUBSTRING(CF.CTRC,4,1)	AND 
                                     CNH.CTRC       = SUBSTRING(CF.CTRC,5,10)
    WHERE
    DT_CHEGADA IS NULL AND CNH.DATACHEGADA IS NOT NULL AND CNH.VALORNF>0
END   
;
BEGIN TRY
    BEGIN TRANSACTION

    BEGIN
        ;
        /* -- Ajuste para evitar o 98 automatico - irá pelas ocorrencias manuais (11/08/2021 13:24)
        INSERT INTO SIC.dbo.CONFIRMAFACILOCORRENCIA
          ( CONFIRMAFACIL_ID, OCORRENCIA_ID, OCORRENCIA_NOME, OCORRENCIA_DATA )
        SELECT
          CF.ID                                           AS CONFIRMAFACIL_ID,
          098                                             AS OCORRENCIA_ID,
          'CHEGADA NA CIDADE OU FILIAL DE DESTINO'        AS OCORRENCIA_NOME,
          CF.DT_CHEGADA                                   AS OCORRENCIA_DATA
        FROM SIC.dbo.CONFIRMAFACIL CF
          JOIN CARGASSQL.dbo.CNH ON CNH.EMP_CODIGO=SUBSTRING(CF.CTRC,1,3) AND CNH.SERIE = SUBSTRING(CF.CTRC,4,1) AND CNH.CTRC = SUBSTRING(CF.CTRC,5,10)
        WHERE FASE_ID <= 2 AND CF.DT_CHEGADA IS NOT NULL
          AND NOT EXISTS ( SELECT 1 FROM SIC.dbo.CONFIRMAFACILOCORRENCIA CO WHERE CO.CONFIRMAFACIL_ID = CF.ID AND CO.OCORRENCIA_ID = 098 ) -- ( 098 passou para manual)
        -- CASO A (FASE < OU = 2) E  NÃO EXISTIR OCORRENCIA = 098 GERADA, INCLUI OCORRENCIA
        */
        ;
        UPDATE CF
          SET FASE_ID = 3,
              DT_UPDATE = CURRENT_TIMESTAMP
        FROM SIC.dbo.CONFIRMAFACIL CF
        WHERE FASE_ID <= 2 AND DT_CHEGADA IS NOT NULL
          AND EXISTS ( SELECT 1 FROM SIC.dbo.CONFIRMAFACILOCORRENCIA CO WHERE CO.CONFIRMAFACIL_ID = CF.ID AND CO.OCORRENCIA_ID = 098 ) -- ( 098 passou para manual)
        -- CASO A (FASE < OU = 2) E EXISTIR OCORRENCIA = 098 GERADA, MUDA PARA FASE = 3        
        ;
    END

    COMMIT TRANSACTION

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK TRANSACTION

    DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE()
    DECLARE @ErrorSeverity INT = ERROR_SEVERITY()
    DECLARE @ErrorState INT = ERROR_STATE()

    RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
END CATCH
;
